{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile_user.username }} | Twitter Clone{% endblock %}

{% block content %}
<div class="row">
    <!-- Profile Information -->
        <div class="col-md-12 mb-4">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 text-center">
                    <img src="{{ profile_user.profile.profile_picture.url }}"
                         alt="{{ profile_user.username }}"
                         class="rounded-circle img-fluid mb-3"
                         style="width: 150px; height: 150px; object-fit: cover;">
                </div>
                <div class="col-md-9">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>{{ profile_user.username }}</h3>
                        {% if user.is_authenticated and user != profile_user %}
                            <div class="d-flex gap-2">
                                <button id="blockBtn"
                                        data-block-url="{% url 'tweets:block_user' profile_user.username %}"
                                        data-unblock-url="{% url 'tweets:unblock_user' profile_user.username %}"
                                        class="btn {% if has_blocked_target %}btn-outline-danger{% else %}btn-danger{% endif %}">
                                    {% if has_blocked_target %}Unblock{% else %}Block{% endif %}
                                </button>
                                {% if not has_blocked_target and not is_blocked_by_target %}
                                    {% if is_following %}
                                        <a href="{% url 'tweets:unfollow_user' profile_user.username %}" class="btn btn-outline-primary">Unfollow</a>
                                    {% else %}
                                        <a href="{% url 'tweets:follow_user' profile_user.username %}" class="btn btn-primary">Follow</a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <p class="text-muted">@{{ profile_user.username }}</p>
                    <p>{{ profile_user.profile.bio }}</p>

                    <div class="d-flex">
                        <div class="me-4">
                            <a href="{% url 'tweets:followers_list' profile_user.username %}"
                               style="--primary-color: #1DA1F2; --primary-hover: #1a91da; text-decoration: none; font-weight: 700;">
                                <strong>{{ followers_count }}</strong> Followers
                            </a>
                        </div>
                        <div>
                            <a href="{% url 'tweets:following_list' profile_user.username %}"
                               style="    --primary-color: #1DA1F2; --primary-hover: #1a91da; text-decoration: none; font-weight: 700;">
                                <strong>{{ following_count }}</strong> Following
                            </a>
                        </div>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            Joined {{ profile_user.profile.date_joined|date:"F Y" }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    
    {% if user.is_authenticated and user == profile_user %}
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Profile</h5>
                <!-- Edit Profile Button -->
                <button class="btn btn-sm btn-outline-primary" id="editProfileBtn">Edit Profile</button>
            </div>
            <div class="card-body" id="editProfileForm" style="display: none;">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ u_form.username.id_for_label }}" class="form-label">Username</label>
                            {{ u_form.username }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ u_form.email.id_for_label }}" class="form-label">Email</label>
                            {{ u_form.email }}
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="{{ p_form.bio.id_for_label }}" class="form-label">Bio</label>
                            {{ p_form.bio }}
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="{{ p_form.profile_picture.id_for_label }}" class="form-label">Profile Picture</label>
                            {{ p_form.profile_picture }}
                        </div>
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript to Toggle Form Visibility -->
    <script>
        document.getElementById("editProfileBtn").addEventListener("click", function() {
            const form = document.getElementById("editProfileForm");
            if (form.style.display === "none") {
                form.style.display = "block";
                this.textContent = "Close Form";
            } else {
                form.style.display = "none";
                this.textContent = "Edit Profile";
            }
        });
    </script>
{% endif %}

    
    <!-- Inside your tweets loop -->
    {% for tweet in tweets %}
    <div class="card mb-3">
        <div class="card-body" id="card-body">
            <div class="d-flex align-items-center mb-2">
                <img src="{{ tweet.user.profile.profile_picture.url }}" alt="{{ tweet.user.username }}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                <div>
                    <h6 class="mb-0">{{ tweet.user.username }}</h6>
                    <small class="text-muted">@{{ tweet.user.username }} Â· {{ tweet.created_at|timesince }} ago</small>
                </div>
            </div>
            <p>{{ tweet.content }}</p>
            {% if tweet.image %}
                <img src="{{ tweet.image.url }}" alt="Tweet image" class="img-fluid rounded mb-2">
            {% endif %}
        
            <div class="d-flex justify-content-between mt-3 align-items-center">
                <div>
                    <a href="{% url 'tweets:tweet_detail' tweet.id %}" class="text-decoration-none me-3">
                        <i class="far fa-comment text-muted"></i> {{ tweet.get_comment_count }}
                    </a>
                    <a href="{% url 'tweets:like_tweet' tweet.id %}" class="text-decoration-none like-btn me-3" data-tweet-id="{{ tweet.id }}">
                        {% if user.is_authenticated and user in tweet.likes.all %}
                            <i class="fas fa-heart text-danger"></i>
                        {% else %}
                            <i class="far fa-heart text-muted"></i>
                        {% endif %}
                        <span class="like-count">{{ tweet.get_like_count }}</span>
                    </a>
                </div>
            
                {% if user == tweet.user %}
<div class="d-flex gap-2">
    <!-- Edit Button -->
    <a href="{% url 'tweets:edit_tweet' tweet.id %}" class="btn btn-sm btn-outline-primary d-flex align-items-center" title="Edit Tweet">
        <i class="fas fa-edit me-1"></i> <span>Edit</span>
    </a>

    <!-- Delete Button -->
    <form method="post" action="{% url 'tweets:delete_tweet' tweet.id %}" onsubmit="return confirm('Are you sure you want to delete this tweet?');" class="m-0">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-outline-danger d-flex align-items-center" title="Delete Tweet">
            <i class="fas fa-trash-alt me-1"></i> <span>Delete</span>
        </button>
    </form>
</div>
{% endif %}

            </div>
        </div>
    </div>
    {% endfor %}
    <!-- Add Bootstrap & FontAwesome in base.html if not already -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Style for Django form fields */
    .form-control {
        display: block;
        width: 100%;
    }
    
    /* Override Django's default styling for form fields */
    input, select, textarea {
        display: block;
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Toggle Block/Unblock via AJAX
        const blockBtn = $('#blockBtn');
        blockBtn.on('click', function(e) {
            e.preventDefault();
            const isUnblock = blockBtn.text().trim().toLowerCase() === 'unblock';
            const url = isUnblock ? blockBtn.data('unblock-url') : blockBtn.data('block-url');
            $.ajax({
                url: url,
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                data: { 'csrfmiddlewaretoken': '{{ csrf_token }}' },
                success: function(resp) {
                    if (resp.status === 'blocked') {
                        blockBtn.text('Unblock').removeClass('btn-danger').addClass('btn-outline-danger');
                    } else if (resp.status === 'unblocked') {
                        blockBtn.text('Block').removeClass('btn-outline-danger').addClass('btn-danger');
                    }
                }
            });
        });
        // AJAX for liking tweets
        $('.like-btn').click(function(e) {
            e.preventDefault();
            var tweetId = $(this).data('tweet-id');
            var likeUrl = "{% url 'tweets:like_tweet' 0 %}".replace('0', tweetId);
            
            $.ajax({
                url: likeUrl,
                type: 'GET',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                success: function(data) {
                    var likeBtn = $('[data-tweet-id="' + tweetId + '"]');
                    var likeIcon = likeBtn.find('i');
                    var likeCount = likeBtn.find('.like-count');
                    
                    if (data.liked) {
                        likeIcon.removeClass('far fa-heart text-muted').addClass('fas fa-heart text-danger');
                    } else {
                        likeIcon.removeClass('fas fa-heart text-danger').addClass('far fa-heart text-muted');
                    }
                    
                    likeCount.text(data.like_count);
                }
            });
        });
    });
</script>
{% endblock %}
